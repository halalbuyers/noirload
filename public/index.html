<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NoirLoad - Free Video Downloader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="logo.png" />
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md text-center">
    <img src="logo.png" alt="NoirLoad Logo" class="w-16 h-16 mx-auto mb-3 rounded-full shadow-md bg-black" />
    <h1 class="text-3xl font-bold mb-2 text-blue-600">NoirLoad</h1>
    <p class="text-sm text-gray-600 mb-6">Created by Ahtesham Ahmad AKA Ahmad Noir ‚Ä¢ <a href="https://instagram.com/the_ahmad_noir" class="text-blue-500 underline">Instagram</a></p>
    <p class="text-green-600 font-medium mb-4">No ads. No registration. Just free downloads.</p>

    <form id="downloadForm" class="space-y-4 text-left">
      <input
        type="text"
        id="videoUrl"
        placeholder="Paste video URL here"
        required
        class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
      />

      <select
        id="format"
        class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option value="mp4">üéûÔ∏è MP4 (Video)</option>
        <option value="mp3">üéµ MP3 (Audio Only)</option>
      </select>

      <select
        id="quality"
        class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option value="best">Auto (Best)</option>
      </select>

      <button
        type="submit"
        class="w-full bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700 transition duration-200"
      >
        Download
      </button>
    </form>

    <p id="status" class="mt-4 text-center text-gray-600"></p>

    <div id="progressBarContainer" class="w-full bg-gray-200 h-3 rounded-full mt-4 hidden">
      <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300 ease-in-out" style="width: 0%"></div>
    </div>

    <div id="progressDetails" class="text-center text-sm text-gray-600 mt-2 hidden">
      <span id="size">üì¶ Size: ‚Äî</span> ‚Ä¢
      <span id="speed">‚ö° Speed: ‚Äî</span>
    </div>
  </div>

  <script>
    const form = document.getElementById("downloadForm");
    const statusText = document.getElementById("status");
    const progressContainer = document.getElementById("progressBarContainer");
    const progressBar = document.getElementById("progressBar");
    const sizeEl = document.getElementById("size");
    const speedEl = document.getElementById("speed");
    const progressDetails = document.getElementById("progressDetails");
    const videoUrlInput = document.getElementById("videoUrl");
    const formatSelect = document.getElementById("format");
    const qualitySelect = document.getElementById("quality");

    let evtSource;

    function listenToProgress() {
      evtSource = new EventSource("/progress");
      evtSource.onmessage = function (event) {
        const { progress, speed, size } = JSON.parse(event.data);
        progressBar.style.width = `${progress}%`;
        statusText.textContent = `‚è≥ Downloading... ${progress.toFixed(1)}%`;
        sizeEl.textContent = `üì¶ Size: ${size || '‚Äî'}`;
        speedEl.textContent = `‚ö° Speed: ${speed || '‚Äî'}`;
        progressDetails.classList.remove("hidden");
      };
    }

    function stopProgress() {
      if (evtSource) evtSource.close();
      progressBar.style.width = "100%";
      setTimeout(() => {
        progressContainer.classList.add("hidden");
        progressDetails.classList.add("hidden");
        progressBar.style.width = "0%";
      }, 3000);
    }

    videoUrlInput.addEventListener("blur", async () => {
      const url = videoUrlInput.value.trim();
      if (!url || formatSelect.value === "mp3") return;

      qualitySelect.innerHTML = `<option value="best">Loading...</option>`;
      try {
        const res = await fetch("/api/formats", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url }),
        });
        const qualities = await res.json();
        qualitySelect.innerHTML = `<option value="best">Auto (Best)</option>`;
        qualities.forEach(q => {
          qualitySelect.innerHTML += `<option value="${q}">${q}p</option>`;
        });
      } catch {
        qualitySelect.innerHTML = `<option value="best">Auto (Best)</option>`;
      }
    });

    formatSelect.addEventListener("change", () => {
      qualitySelect.disabled = formatSelect.value === "mp3";
    });

    form.onsubmit = async (e) => {
      e.preventDefault();
      const url = videoUrlInput.value.trim();
      const format = formatSelect.value;
      const quality = qualitySelect.value;
      if (!url) return;

      statusText.textContent = "‚è≥ Starting download...";
      progressContainer.classList.remove("hidden");
      progressBar.style.width = "0%";
      listenToProgress();

      try {
        const res = await fetch("/api/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, format, quality }),
        });

        stopProgress();

        if (!res.ok) {
          const error = await res.text();
          statusText.textContent = "‚ùå Error: " + error;
          return;
        }

        const blob = await res.blob();
        const a = document.createElement("a");
        a.href = window.URL.createObjectURL(blob);
        a.download = format === "mp3" ? "audio.mp3" : "video.mp4";
        a.click();

        statusText.textContent = "‚úÖ Download started!";
      } catch (error) {
        stopProgress();
        statusText.textContent = "‚ùå Download failed.";
        console.error(error);
      }
    };
  </script>
</body>
</html>
